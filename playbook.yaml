---
- hosts: all
  become: yes

tasks:
    - name: Installation de Git
      package:
        name: git
        state: latest

    - name: Clonage du repository Golang-myip
      git:
       repo: https://github.com/BastienBalaud/golang-myip.git
       dest: /golang-myip
       clone: yes
       update: yes

    - name: Installation de la commande make
      ansible.builtin.shell:
       cmd: yum install make.x86_64 -y

    - name: Installation du langage Go
      ansible.builtin.shell:
       cmd: yum install golang.x86_64 -y

    - name: Execution du fichier Makefile dans son répertoire
      ansible.builtin.shell:
       cmd: make
       chdir: /golang-myip

    - name: Création du ficher golang-myip.service dans le dossier Temporaire
      ansible.builtin.shell:
       cmd: touch /tmp/golang-myip.service
       cmd: echo "[Unit]" >> /tmp/golang-myip.service
       cmd: echo "Description=Service système Golang-MyIP" >> /tmp/golang-myip.service
       cmd: echo "" >> /tmp/golang-myip.service
       cmd: echo "#Ciblage du service réseau" >> /tmp/golang-myip.service
       cmd: echo "After=network.target" >> /tmp/golang-myip.service
       cmd: echo "" >> /tmp/golang-myip.service
       cmd: echo "[Service]" >> /tmp/golang-myip.service
       cmd: echo "" >> /tmp/golang-myip.service
       cmd: echo "#Sélection du répertoire d'éxécution du fichier" >> /tmp/golang-myip.service
       cmd: echo "WorkingDirectory=/golang-myip/" >> /tmp/golang-myip.service
       cmd: echo "ExecStart=/golang-myip/build/server.x86_64" >> /tmp/golang-myip.service
       cmd: echo "" >> /tmp/golang-myip.service
       cmd: echo "[Install]" >> /tmp/golang-myip.service
       cmd: echo "" >> /tmp/golang-myip.service
       cmd: echo "#Installation pour tout les utilisateurs" >> /tmp/golang-myip.service
       cmd: echo "WantedBy=multi-user.target" >> /tmp/golang-myip.service

    - name: Déplacement du fichier golang-myip.service dans systemd
      ansible.builtin.shell:
       cmd: mv /tmp/golang-myip.service /etc/systemd/system/

    - name: Changer temporairement le SELinux en Permissive pour activer le service
      ansible.builtin.shell:
       cmd: setenforce 0

    - name: Redémarrage du Daemon système
      ansible.builtin.shell:
       cmd: systemctl daemon-reload

    - name: Démarrage du nouveau service Golang-MyIP
      ansible.builtin.shell:
       cmd: systemctl start golang-myip

    - name: Activation du service Golang-MyIP au démarrage du système
      ansible.builtin.shell:
       cmd: systemctl enable golang-myip
